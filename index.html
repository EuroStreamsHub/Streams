<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stream Selector</title>
  <style>
    :root {
      --primary: #ee1c25;
      --secondary: #ffffff;
      --accent: #000000;
      --bg-dark: #121212;
      --shadow: rgba(0, 0, 0, 0.25);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%; background-color: var(--bg-dark);
      color: var(--secondary); font-family: 'Segoe UI', Roboto, sans-serif;
      display: flex; flex-direction: column;
    }
    .controls { padding: 2rem 1rem; text-align: center; }
    select {
      padding: 0.75rem 1rem; font-size: 1rem;
      border-radius: 0.5rem; border: 2px solid var(--primary);
      background-color: var(--bg-dark); color: var(--secondary);
      margin-bottom: 1rem; max-width: 90%;
    }
    .button-group { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem; }
    .button {
      background: var(--primary); color: var(--secondary);
      padding: 0.8rem 2rem; border: none; border-radius: 0.5rem;
      font-size: 1rem; font-weight: bold; cursor: pointer;
    }
    .button:hover {
      background: var(--secondary); color: var(--accent);
      box-shadow: 0 0 10px var(--primary);
    }
    .stream-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; padding: 1rem; }
    .stream-container {
      width: 90%; max-width: 1200px; height: 70vh; background: #000;
      border: 4px solid var(--primary); border-radius: 1rem;
      position: relative; overflow: hidden; box-shadow: 0 10px 30px var(--shadow);
    }
    iframe { width: 100%; height: 100%; border: none; }
    .loader {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); border: 6px solid #ccc;
      border-top: 6px solid var(--primary); border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; z-index: 5;
    }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    @media (max-width: 768px) { .stream-container { height: 50vh; } }
  </style>
</head>
<body>

  <div class="controls">
    <select id="dropdown-menu" onchange="loadStream()">
      <option value="">Select a Stream</option>
    </select>

    <div class="button-group">
      <button class="button" onclick="refreshStream()">Refresh</button>
      <button class="button" onclick="fetchStreams()">Fetch Streams</button>
      <button class="button" onclick="toggleFullScreen()">Fullscreen</button>
    </div>
  </div>

  <div class="stream-wrapper">
    <div class="stream-container">
      <div class="loader" id="loader"></div>
      <iframe id="stream-iframe" allowfullscreen sandbox="allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation allowTransparency" onload="hideLoader()"></iframe>
    </div>
  </div>

  <script>
    const loader = document.getElementById("loader");
    const ALLOWED = ["England League One", "England League Two", "EPL", "England Championship"];

    // Use AllOrigins proxy
    const API_URL = "https://api.allorigins.win/get?url=" + encodeURIComponent("https://klubsports.store/voodc/schedule.php");

    async function fetchStreams() {
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        const matches = JSON.parse(data.contents); // actual data inside "contents"

        const dropdown = document.getElementById("dropdown-menu");
        const selected = dropdown.value; // keep current selection
        dropdown.innerHTML = '<option value="">Select a Stream</option>'; // reset

        matches.forEach(match => {
          if (match.category === "SOCCER" && ALLOWED.includes(match.info)) {
            let title = match.title || '';
            if (title.includes("[") && !title.toLowerCase().includes("[english]")) return;
            let clean_title = title.replace("[english]", "").trim();
            const match_id = match.id;
            const url = `https://www.voodc.cfd/p/voodc37-embed.html?id=${match_id}`;
            const option = document.createElement("option");
            option.value = url;
            option.textContent = clean_title;
            dropdown.appendChild(option);
          }
        });

        // restore selection if still valid
        if ([...dropdown.options].some(o => o.value === selected)) {
          dropdown.value = selected;
        }
      } catch (err) {
        console.error("Failed to fetch streams:", err);
      }
    }

    function loadStream() {
      const dropdown = document.getElementById("dropdown-menu");
      const iframe = document.getElementById("stream-iframe");
      const streamUrl = dropdown.value;
      if (streamUrl) {
        loader.style.display = "block";
        iframe.src = streamUrl;
      } else {
        iframe.src = '';
      }
    }

    async function refreshStream() {
      await fetchStreams(); // fetch latest streams
      loadStream();         // reload selected stream
    }

    function toggleFullScreen() {
      const iframe = document.getElementById("stream-iframe");
      if (!document.fullscreenElement) {
        iframe.requestFullscreen?.() || iframe.webkitRequestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    }

    function hideLoader() { loader.style.display = "none"; }

    // Initial load
    fetchStreams();

    // Auto-refresh every 5 minutes (300,000 ms)
    setInterval(refreshStream, 300000);
  </script>

</body>
</html>
