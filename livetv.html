<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live TV</title>
<style>
body {
  margin:0;
  font-family:'Segoe UI',Roboto,sans-serif;
  background: radial-gradient(circle at top, #1e1e1e, #0b0b0b);
  color:#fff;
}

/* HEADER & CONTROLS */
.header {
  padding:1rem;
  text-align:center;
}

.controls {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:.6rem;
  margin-bottom:1rem;
}

.controls input {
  padding:.6rem 1rem;
  border-radius:.4rem;
  border:none;
  font-weight:600;
  flex:1 1 200px;
  max-width:240px;
}

/* GRID & CARD */
.grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:1rem;
  padding:1rem;
}

@media (min-width:900px){ .grid { grid-template-columns:repeat(3,1fr); } }
@media (min-width:1200px){ .grid { grid-template-columns:repeat(4,1fr); } }

.card {
  background:#121212;
  border-radius:.7rem;
  overflow:hidden;
  cursor:pointer;
  transition:.2s;
  display:flex;
  flex-direction:column;
  aspect-ratio:9/16;
}
.card:hover { transform:scale(1.04); }

/* POSTER TOP HALF */
.poster {
  flex:1;
  background-size:cover;
  background-position:center;
  position:relative;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:1rem;
  text-align:center;
  padding:.5rem;
  color:#fff;
}

/* INFO BOTTOM HALF */
.info {
  flex:1;
  padding:.6rem;
  display:flex;
  flex-direction:column;
  justify-content:center;
  text-align:center;
  background:#181818;
}

.channel-name {
  font-weight:600;
  font-size:.95rem;
  line-height:1.2;
}
</style>
</head>
<body>

<div class="header">
  <h2>Live TV</h2>
  <div class="controls">
    <input id="search" placeholder="Search channelsâ€¦">
  </div>
</div>

<div id="grid" class="grid"></div>

<script>
const grid = document.getElementById("grid");
const searchInput = document.getElementById("search");

/* ---------- FETCH CHANNELS ---------- */
let allChannels = [];

async function fetchChannels(){
  try{
    const res = await fetch("https://beta.adstrim.ru/api/channels");
    const data = await res.json();
    if(data.status==="success"){
      allChannels = data.channels.filter(c=>c.show_on_livetv);
      render();
    }
  }catch(err){
    console.error("Failed to fetch channels", err);
    grid.innerHTML = "<p style='text-align:center;color:red;'>Failed to load channels</p>";
  }
}

/* ---------- AUTO-GENERATE GITHUB LOGO URL ---------- */
function getLogoUrl(channelName){
  // Extract country code from brackets if exists
  let countryCodeSuffix = "";
  const match = channelName.match(/\[(.*?)\]/);
  if(match) countryCodeSuffix = "-" + match[1].toLowerCase();

  // Remove brackets content
  let cleanName = channelName.replace(/\[.*?\]/g, "").trim().toLowerCase();

  // Replace non-alphanumeric chars with hyphens
  cleanName = cleanName.replace(/[^a-z0-9]/g,"-");

  // Default country folder
  const countryFolder = "united-kingdom";

  return `https://raw.githubusercontent.com/tv-logo/tv-logos/refs/heads/main/countries/${countryFolder}/${cleanName}${countryCodeSuffix}.png`;
}

/* ---------- RENDER GRID ---------- */
function render(){
  grid.innerHTML = "";
  const q = searchInput.value.toLowerCase();
  const list = allChannels.filter(c=>c.name.toLowerCase().includes(q));

  list.forEach(c=>{
    const card = document.createElement("div");
    card.className="card";

    const poster = document.createElement("div");
    poster.className="poster";

    const logoUrl = getLogoUrl(c.name);
    const img = new Image();
    img.src = logoUrl;
    img.style.maxWidth="90%";
    img.style.maxHeight="90%";
    img.onload = ()=> poster.appendChild(img);
    img.onerror = ()=> poster.textContent = c.name; // fallback to text

    const info = document.createElement("div");
    info.className="info";

    const nameDiv = document.createElement("div");
    nameDiv.className="channel-name";
    nameDiv.textContent = c.name;

    info.appendChild(nameDiv);
    card.appendChild(poster);
    card.appendChild(info);

    card.onclick = ()=>location.href=`viewer.html?type=livetv&channel=${encodeURIComponent(c.name)}`;

    grid.appendChild(card);
  });

  if(list.length===0){
    grid.innerHTML = "<p style='text-align:center;opacity:.6;'>No channels found</p>";
  }
}

/* ---------- EVENTS ---------- */
searchInput.oninput = render;

/* ---------- INITIAL LOAD ---------- */
fetchChannels();
</script>
</body>
</html>
