<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Streams</title>

<style>
body {
  margin:0;
  font-family:'Segoe UI',Roboto,sans-serif;
  background:#121212;
  color:#fff;
}

h1 {
  text-align:center;
  padding:1rem;
}

.top-bar {
  max-width:800px;
  margin:0 auto;
  padding:0 1rem 1rem;
}

.top-row {
  display:flex;
  gap:.5rem;
  align-items:center;
}

button {
  background:#1f1f1f;
  color:#fff;
  padding:.5rem 1rem;
  border:none;
  border-radius:.4rem;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}

button:hover {
  background:#FF6700;
}

input#search {
  flex:1;
  padding:.5rem 1rem;
  border-radius:.4rem;
  border:none;
  background:#1f1f1f;
  color:#fff;
}

.filter-row {
  display:flex;
  gap:.5rem;
  margin-top:.5rem;
}

.match-list {
  max-width:800px;
  margin:0 auto;
  padding:0 1rem 1rem;
}

.match-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#1f1f1f;
  margin-bottom:.5rem;
  padding:.6rem 1rem;
  border-radius:.5rem;
  cursor:pointer;
  transition:.2s;
}

.match-bar:hover {
  background:#FF6700;
}

.match-info div:first-child {
  font-weight:600;
}

.match-info div:last-child {
  font-size:.85rem;
  opacity:.8;
}
</style>
</head>

<body>

<h1>Live Matches</h1>

<div class="top-bar">
  <div class="top-row">
    <button onclick="goHome()">â¬… Home</button>
    <input type="text" id="search" placeholder="Search teams...">
  </div>

  <div class="filter-row">
    <button id="btnNormal">All (12h)</button>
    <button id="btnSoon">Starting Soon</button>
    <button id="btnLive">Live</button>
  </div>
</div>

<div class="match-list" id="matchList">
  Loading matches...
</div>

<script>
const matchList = document.getElementById('matchList');
const searchInput = document.getElementById('search');

const btnNormal = document.getElementById('btnNormal');
const btnSoon   = document.getElementById('btnSoon');
const btnLive   = document.getElementById('btnLive');

let allMatches = [];
let activeMode = 'normal';

// ---- TIME HELPERS ----
const NOW = () => Math.floor(Date.now() / 1000);

function formatKO(ts){
  const d = new Date(ts * 1000);
  return d.toLocaleTimeString([], {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  });
}

function isWithinNextHours(match, hours){
  return match.timestamp >= NOW() &&
         match.timestamp <= NOW() + (hours * 3600);
}

function isStartingSoon(match){
  return match.timestamp >= NOW() &&
         match.timestamp <= NOW() + 3600;
}

function isLive(match){
  return match.timestamp >= NOW() - 300 &&
         match.timestamp <= NOW() + 7200;
}

// ---- LOAD MATCHES ----
async function loadMatches(){
  matchList.textContent = "Loading matches...";
  try {
    const res = await fetch('https://beta.adstrim.ru/api/events');
    const data = await res.json();

    allMatches = data.data
      .filter(m => m.sport === "Football")
      .filter(m => isWithinNextHours(m, 12))
      .sort((a,b) => a.timestamp - b.timestamp);

    renderMatches(allMatches);

  } catch(e){
    console.error(e);
    matchList.textContent = "Error loading matches.";
  }
}

// ---- RENDER ----
function renderMatches(matches){
  matchList.innerHTML = '';

  if(matches.length === 0){
    matchList.textContent = 'No matches found.';
    return;
  }

  matches.forEach(match => {
    const home = match.home_team || match.teams?.home?.name || "Home";
    const away = match.away_team || match.teams?.away?.name || "Away";

    const channels = match.channels || [];
    const channelCount = channels.length;

    const timeLabel = isLive(match)
      ? 'LIVE'
      : `KO ${formatKO(match.timestamp)}`;

    const bar = document.createElement('div');
    bar.className = 'match-bar';

    bar.innerHTML = `
      <div class="match-info">
        <div>${home} vs ${away}</div>
        <div>${timeLabel}</div>
      </div>
      <span>${channelCount} channel${channelCount !== 1 ? 's' : ''}</span>
    `;

    bar.onclick = () => {
      if(channelCount === 0){
        alert("No channels available.");
        return;
      }
      const channelName = encodeURIComponent(channels[0].name);
      window.location.href =
        `viewer.html?type=football&mirror=${channelName}&title=${encodeURIComponent(home + ' vs ' + away)}`;
    };

    matchList.appendChild(bar);
  });
}

// ---- FILTER BUTTONS ----
function setMode(mode){
  if(activeMode === mode){
    mode = 'normal';
  }

  activeMode = mode;

  let filtered = [];

  if(mode === 'soon'){
    filtered = allMatches.filter(isStartingSoon);
  } else if(mode === 'live'){
    filtered = allMatches.filter(isLive);
  } else {
    filtered = allMatches.filter(m => isWithinNextHours(m, 12));
  }

  renderMatches(filtered);
}

btnNormal.onclick = () => setMode('normal');
btnSoon.onclick   = () => setMode('soon');
btnLive.onclick   = () => setMode('live');

// ---- SEARCH ----
searchInput.addEventListener('input', () => {
  const term = searchInput.value.toLowerCase();

  const base =
    activeMode === 'soon' ? allMatches.filter(isStartingSoon) :
    activeMode === 'live' ? allMatches.filter(isLive) :
    allMatches.filter(m => isWithinNextHours(m, 12));

  const filtered = base.filter(m => {
    const h = m.home_team?.toLowerCase() || '';
    const a = m.away_team?.toLowerCase() || '';
    return h.includes(term) || a.includes(term);
  });

  renderMatches(filtered);
});

// ---- NAV ----
function goHome(){
  window.location.href = "index.html";
}

window.history.pushState(null, document.title, window.location.href);
window.addEventListener('popstate', () => {
  window.location.href = "index.html";
});

// ---- INIT ----
loadMatches();
</script>

</body>
</html>
