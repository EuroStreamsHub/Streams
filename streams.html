<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Matches</title>

<style>
body {
  margin:0;
  font-family:'Segoe UI',Roboto,sans-serif;
  background:#121212;
  color:#fff;
}

h1 {
  text-align:center;
  padding:1rem;
}

.top-bar {
  max-width:800px;
  margin:0 auto;
  padding:0 1rem 1rem;
}

.top-row {
  display:flex;
  gap:.5rem;
  align-items:center;
}

button {
  background:#1f1f1f;
  color:#fff;
  padding:.5rem 1rem;
  border:none;
  border-radius:.4rem;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}

button:hover {
  background:#FF6700;
}

input#search {
  flex:1;
  padding:.5rem 1rem;
  border-radius:.4rem;
  border:none;
  background:#1f1f1f;
  color:#fff;
}

.filter-row {
  display:flex;
  gap:.5rem;
  margin-top:.5rem;
  flex-wrap:wrap;
}

.match-list {
  max-width:800px;
  margin:0 auto;
  padding:0 1rem 1rem;
}

.match-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#1f1f1f;
  margin-bottom:.5rem;
  padding:.6rem 1rem;
  border-radius:.5rem;
  cursor:pointer;
  transition:.2s;
}

.match-bar:hover {
  background:#FF6700;
}

.match-info div:first-child {
  font-weight:600;
}

.match-info div:last-child {
  font-size:.85rem;
  opacity:.85;
}

/* LIVE pulse */
.live {
  color:#ff3b3b;
  font-weight:700;
  display:inline-flex;
  align-items:center;
  gap:6px;
}

.live::before {
  content:'';
  width:8px;
  height:8px;
  background:#ff3b3b;
  border-radius:50%;
  animation:pulse 1.4s infinite;
}

@keyframes pulse {
  0% { transform:scale(1); opacity:1; }
  70% { transform:scale(1.6); opacity:0; }
  100% { transform:scale(1); opacity:0; }
}
</style>
</head>

<body>

<h1>Live Matches</h1>

<div class="top-bar">
  <div class="top-row">
    <button onclick="goHome()">â¬… Home</button>
    <input type="text" id="search" placeholder="Search teams...">
  </div>

  <div class="filter-row">
    <button id="btnTopEmbed">Source 1 (TopEmbed)</button>
    <button id="btnSPK">Source 2 (streamed.pk)</button>
    <button id="btnNormal">All (12h)</button>
    <button id="btnSoon">Starting Soon</button>
    <button id="btnLive">Live</button>
  </div>
</div>

<div class="match-list" id="matchList">Loading matches...</div>

<script>
const matchList = document.getElementById('matchList');
const searchInput = document.getElementById('search');
const btnNormal = document.getElementById('btnNormal');
const btnSoon   = document.getElementById('btnSoon');
const btnLive   = document.getElementById('btnLive');
const btnTopEmbed = document.getElementById('btnTopEmbed');
const btnSPK = document.getElementById('btnSPK');

let allMatches = [];
let activeMode = 'normal';
let currentSource = 'topembed'; // default

/* ---- TIME HELPERS ---- */
const NOW = () => Math.floor(Date.now() / 1000);

function formatKO(ts){
  const d = new Date(ts * 1000);
  return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', hour12:false });
}

function isLive(m){
  return NOW() >= m.timestamp - 300 &&
         NOW() <= m.timestamp + 7200;
}

function isStartingSoon(m){
  return m.timestamp > NOW() + 300 &&
         m.timestamp <= NOW() + 3600;
}

function isWithinNextHours(m,h){
  return m.timestamp >= NOW() &&
         m.timestamp <= NOW() + h * 3600;
}

function sortLiveFirst(list){
  return list.sort((a,b)=>{
    const aL = isLive(a), bL = isLive(b);
    if(aL && !bL) return -1;
    if(!aL && bL) return 1;
    return a.timestamp - b.timestamp;
  });
}

/* ---- FETCH MATCHES ---- */
async function loadMatches(source='topembed'){
  matchList.textContent = 'Loading matches...';
  currentSource = source;

  try{
    let data = [];
    if(source === 'topembed'){
      const res = await fetch('https://beta.adstrim.ru/api/events');
      const json = await res.json();
      data = json.data.filter(m => m.sport === 'Football');
      allMatches = data.map(m => ({
        ...m,
        timestamp: Math.floor((m.timestamp || (Date.now()/1000)) ), // ensure timestamp
        home: m.home_team || m.teams?.home?.name || m.title?.split(' vs ')[0],
        away: m.away_team || m.teams?.away?.name || m.title?.split(' vs ')[1] || '',
        channels: m.channels || []
      })).filter(m => isWithinNextHours(m,12) || isLive(m));

    } else if(source === 'spk'){
      const res = await fetch('https://streamed.pk/api/matches/football');
      const json = await res.json();
      allMatches = json.map(m => ({
        ...m,
        timestamp: Math.floor(m.date/1000),
        home: m.teams?.home?.name || m.title?.split(' vs ')[0],
        away: m.teams?.away?.name || m.title?.split(' vs ')[1] || '',
        channels: m.sources || []
      })).filter(m => isWithinNextHours(m,12) || isLive(m));
    }

    renderMatches(sortLiveFirst(allMatches));

  } catch(e){
    console.error(e);
    matchList.textContent = 'Error loading matches.';
  }
}

/* ---- RENDER MATCHES ---- */
function renderMatches(matches){
  matchList.innerHTML = '';
  if(!matches.length){ matchList.textContent = 'No matches found.'; return; }

  matches.forEach(m=>{
    const timeLabel = isLive(m) ? '<span class="live">LIVE</span>' : `KO ${formatKO(m.timestamp)}`;
    const count = m.channels.length;

    const bar = document.createElement('div');
    bar.className = 'match-bar';
    bar.innerHTML = `
      <div class="match-info">
        <div>${m.home} vs ${m.away}</div>
        <div>${timeLabel}</div>
      </div>
      <span>${count} source${count !== 1 ? 's' : ''}</span>
    `;

    bar.onclick = ()=>{
      if(!count){ alert('No sources available.'); return; }

      if(currentSource==='topembed'){
        const mirror = encodeURIComponent(m.channels[0].name);
        window.location.href = `viewer.html?type=football&mirror=${mirror}&title=${encodeURIComponent(m.home+' vs '+m.away)}`;
      } else {
        const spkSource = encodeURIComponent(m.channels[0].source);
        window.location.href = `viewer.html?type=football&source=${spkSource}&title=${encodeURIComponent(m.home+' vs '+m.away)}`;
      }
    };

    matchList.appendChild(bar);
  });
}

/* ---- FILTER BUTTONS ---- */
function setMode(mode){
  if(activeMode === mode) mode = 'normal';
  activeMode = mode;

  let filtered;
  if(mode === 'soon') filtered = allMatches.filter(isStartingSoon);
  else if(mode === 'live') filtered = allMatches.filter(isLive);
  else filtered = allMatches.filter(m => isWithinNextHours(m,12) || isLive(m));

  renderMatches(sortLiveFirst(filtered));
}

/* ---- SEARCH ---- */
searchInput.addEventListener('input', ()=>{
  const term = searchInput.value.toLowerCase();

  let base;
  if(activeMode === 'soon') base = allMatches.filter(isStartingSoon);
  else if(activeMode === 'live') base = allMatches.filter(isLive);
  else base = allMatches.filter(m => isWithinNextHours(m,12) || isLive(m));

  const filtered = base.filter(m=>{
    const h = m.home.toLowerCase();
    const a = m.away.toLowerCase();
    return h.includes(term) || a.includes(term);
  });

  renderMatches(sortLiveFirst(filtered));
});

/* ---- NAV ---- */
function goHome(){ window.location.href = 'index.html'; }

window.history.pushState(null,document.title,window.location.href);
window.addEventListener('popstate',()=>{ window.location.href='index.html'; });

/* ---- BUTTON EVENTS ---- */
btnNormal.onclick = () => setMode('normal');
btnSoon.onclick   = () => setMode('soon');
btnLive.onclick   = () => setMode('live');
btnTopEmbed.onclick = () => loadMatches('topembed');
btnSPK.onclick = () => loadMatches('spk');

/* ---- INIT ---- */
loadMatches('topembed');
</script>

</body>
</html>
