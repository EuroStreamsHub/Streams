<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stream Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  padding: 10px;
  background: #111;
  border-bottom: 1px solid #222;
  font-size: 14px;
  text-align: center;
}

#mirrors {
  display: none;
  background: #111;
  border-bottom: 1px solid #222;
  padding: 6px;
  gap: 6px;
  overflow-x: auto;
  white-space: nowrap;
}

#mirrors button {
  background: #222;
  border: 1px solid #333;
  color: #fff;
  padding: 6px 10px;
  cursor: pointer;
}

#mirrors button:hover {
  background: #444;
}

#player {
  flex: 1;
  border: none;
  width: 100%;
}

#loader {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #333;
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>

<body>

<header id="title">Loadingâ€¦</header>

<div id="mirrors"></div>

<div id="loader">
  <div class="spinner"></div>
</div>

<iframe id="player" allowfullscreen allow="autoplay; fullscreen"></iframe>

<script>
const params = new URLSearchParams(location.search);

const type    = params.get("type");
const title   = decodeURIComponent(params.get("title") || "");
const imdb    = params.get("imdb");
const mirror  = params.get("mirror");
const channel = params.get("channel");

const player  = document.getElementById("player");
const loader  = document.getElementById("loader");
const mirrorsBox = document.getElementById("mirrors");
const titleEl = document.getElementById("title");

titleEl.textContent = title || "Stream Viewer";

function hideLoader() {
  loader.style.display = "none";
}

/* =========================
   MOVIES
========================= */
if (type === "movie") {
  if (!imdb) {
    alert("Movie ID missing");
    hideLoader();
  } else {
    const clean = imdb.replace(/^tt/, "");
    player.src = `https://vidfast.pro/movie/${clean}`;
  }
}

/* =========================
   LIVE TV / MATCHES
========================= */
else if (type === "livetv") {
  const selectedChannel = mirror || channel;

  if (!selectedChannel) {
    alert("Channel not provided");
    hideLoader();
  } else {
    loadChannel(selectedChannel);

    // ðŸ” MATCH DETECTION
    if (/\bvs\b/i.test(title)) {
      loadMirrors();
    }
  }
}

/* =========================
   FUNCTIONS
========================= */
function loadChannel(name) {
  loader.style.display = "flex";
  player.src = `https://topembed.pw/channel/${encodeURIComponent(name)}`;
}

async function loadMirrors() {
  try {
    const res = await fetch("https://topembed.pw/api/live");
    const json = await res.json();

    const match = json.data.find(e =>
      title.toLowerCase().includes(e.home_team.toLowerCase()) &&
      title.toLowerCase().includes(e.away_team.toLowerCase())
    );

    if (!match || !match.channels) return;

    mirrorsBox.innerHTML = "";
    mirrorsBox.style.display = "flex";

    match.channels.forEach(ch => {
      const btn = document.createElement("button");
      btn.textContent = ch.name;
      btn.onclick = () => loadChannel(ch.name);
      mirrorsBox.appendChild(btn);
    });

  } catch (e) {
    console.warn("Mirror fetch failed");
  }
}

player.onload = hideLoader;
</script>

</body>
</html>
