<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stream Viewer</title>
<style>
body {
  margin:0;
  font-family:'Segoe UI',Roboto,sans-serif;
  background:#121212;
  color:#fff;
  text-align:center;
}

.back-button {
  display:inline-block;
  margin:1rem;
  background:#1f1f1f;
  color:#fff;
  padding:.6rem 1rem;
  border-radius:.5rem;
  text-decoration:none;
}

.stream-container {
  max-width:1000px;
  aspect-ratio:16/9;
  margin:1rem auto;
  background:#000;
  position:relative;
  border-radius:.5rem;
  overflow:hidden;
}

iframe {
  width:100%;
  height:100%;
  border:none;
}

.loader {
  position:absolute;
  top:50%;
  left:50%;
  width:50px;
  height:50px;
  border:6px solid rgba(255,255,255,.2);
  border-top:6px solid #FF6700;
  border-radius:50%;
  transform:translate(-50%,-50%);
  animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:translate(-50%,-50%) rotate(360deg); } }

.channel-list {
  max-width:800px;
  margin:1rem auto;
  text-align:left;
}

.channel-item {
  padding:.5rem 1rem;
  margin-bottom:.3rem;
  background:#1f1f1f;
  border-radius:.4rem;
  cursor:pointer;
  transition:.2s;
}
.channel-item:hover { background:#FF6700; }
</style>
</head>
<body>

<a class="back-button" href="streams.html">â¬… Back</a>
<h2 id="title">Stream</h2>

<div class="stream-container">
  <div class="loader" id="loader"></div>
  <iframe id="player" allowfullscreen></iframe>
</div>

<div class="channel-list" id="channelList">
  Loading channels...
</div>

<script>
const params = new URLSearchParams(location.search);
const type = params.get("type");        // should be "livetv"
const title = params.get("title");      // e.g., "Newcastle United vs Manchester City"
const mirrorParam = params.get("mirror");// e.g., "ITV1[UK]"

const player = document.getElementById("player");
const loader = document.getElementById("loader");
const channelList = document.getElementById("channelList");

document.getElementById("title").textContent = title || "Stream";

// Load TopEmbed channels
async function loadChannels(){
  loader.style.display = "block";
  channelList.textContent = "Loading channels...";

  try {
    const res = await fetch('https://beta.adstrim.ru/api/events');
    const data = await res.json();

    // Find the match by title
    const match = data.data.find(m=>{
      const home = m.home_team || (m.teams?.home?.name || "");
      const away = m.away_team || (m.teams?.away?.name || "");
      return `${home} vs ${away}` === title;
    });

    if(!match || !match.channels || match.channels.length === 0){
      channelList.textContent = "No channels available for this match.";
      loader.style.display = "none";
      return;
    }

    // Show list of channels
    channelList.innerHTML = '';
    match.channels.forEach(channel=>{
      const item = document.createElement('div');
      item.className = 'channel-item';
      item.textContent = channel.name;
      item.onclick = () => {
        const encoded = encodeURIComponent(channel.name);
        player.src = `https://topembed.pw/channel/${encoded}`;
        loader.style.display = "block";
      };
      channelList.appendChild(item);
    });

    // Load the initial channel (mirrorParam if exists)
    let initialChannel = mirrorParam || match.channels[0].name;
    player.src = `https://topembed.pw/channel/${encodeURIComponent(initialChannel)}`;
  } catch(e){
    console.error(e);
    channelList.textContent = "Error loading channels.";
  }

  player.onload = ()=>loader.style.display="none";
}

loadChannels();
</script>
</body>
</html>
