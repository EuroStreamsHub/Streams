<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stream Viewer</title>
<style>
body {
  margin:0;
  font-family:'Segoe UI',Roboto,sans-serif;
  background:#121212;
  color:#fff;
  text-align:center;
}
.back-button {
  display:inline-block;
  margin:1rem;
  background:#1f1f1f;
  color:#fff;
  padding:.6rem 1rem;
  border-radius:.5rem;
  text-decoration:none;
}
h2#title { margin-bottom:.5rem; }
.stream-container {
  max-width:1000px;
  aspect-ratio:16/9;
  margin:1rem auto;
  background:#000;
  position:relative;
  border-radius:.5rem;
  overflow:hidden;
}
iframe {
  width:100%;
  height:100%;
  border:none;
}
.loader {
  position:absolute;
  top:50%;
  left:50%;
  width:50px;
  height:50px;
  border:6px solid rgba(255,255,255,.2);
  border-top:6px solid #FF6700;
  border-radius:50%;
  transform:translate(-50%,-50%);
  animation:spin 1s linear infinite;
}
@keyframes spin { to { transform:translate(-50%,-50%) rotate(360deg); } }
.mirrors {
  display:flex;
  justify-content:center;
  gap:.5rem;
  flex-wrap:wrap;
  margin-bottom:1rem;
}
button.mirror-btn {
  padding:.5rem 1rem;
  border:none;
  border-radius:.4rem;
  background:#1f1f1f;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
button.mirror-btn:hover { background:#FF6700; }
</style>
</head>
<body>

<a class="back-button" href="#">â¬… Back</a>
<h2 id="title">Stream</h2>

<div class="stream-container">
  <div class="loader" id="loader"></div>
  <iframe id="player" allowfullscreen></iframe>
</div>

<div class="mirrors" id="mirrors"></div>

<script>
const params = new URLSearchParams(location.search);
const type = params.get("type");        // "livetv" | "football" | "movies"
const title = params.get("title");
const channel = params.get("channel");  // TopEmbed channel

const player = document.getElementById("player");
const loader = document.getElementById("loader");
const mirrorsDiv = document.getElementById("mirrors");

document.getElementById("title").textContent = title || "Stream";

/* ---------- LOAD TOP EMBED ---------- */
async function loadTopEmbed(channelName){
  loader.style.display="block";
  try{
    const res = await fetch("https://beta.adstrim.ru/api/events");
    const data = await res.json();
    // find the first match with this channel
    let match = data.data.find(m=>{
      return m.channels.some(c=>c.name===channelName);
    });
    if(!match){
      player.src="about:blank";
      alert("Channel not found in API");
      loader.style.display="none";
      return;
    }

    // get all channels for that match
    const channels = match.channels.filter(c=>c.name===channelName);
    // TopEmbed iframe URL
    function embedUrl(chan){ return `https://topembed.pw/channel/${encodeURIComponent(chan.name)}`; }

    // Set first channel
    player.src = embedUrl(channels[0]);
    loader.style.display="none";

    // Populate mirrors buttons
    mirrorsDiv.innerHTML="";
    channels.forEach((chan,i)=>{
      const btn = document.createElement("button");
      btn.className="mirror-btn";
      btn.textContent = i===0 ? "Main" : `Mirror ${i}`;
      btn.onclick = ()=>{
        loader.style.display="block";
        player.src = embedUrl(chan);
      };
      mirrorsDiv.appendChild(btn);
    });

  } catch(e){
    console.error(e);
    loader.style.display="none";
    alert("Error loading TopEmbed stream");
  }
}

/* ---------- BACK BUTTON ---------- */
document.querySelector(".back-button").onclick = ()=>{
  if(type==="livetv") window.location.href="streams.html";
  else window.history.back();
};

if(type==="livetv" && channel){
  loadTopEmbed(channel);
}
</script>
</body>
</html>
